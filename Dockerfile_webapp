# 1. Use newer CUDA base (Ubuntu 22.04 is better for Python 3.10+)
# CUDA 11.8 is the standard for modern PyTorch
FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

# Basic setup
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV UV_PYTHON_DOWNLOADS=auto

# Define User Args
ARG UID=1000
ARG GID=1000
ARG USER=developer

# 2. Install System Dependencies (Includes Python build deps & Graphics libs)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    wget \
    build-essential \
    gcc \
    g++ \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    # Dependencies for building Python if uv needs to compile it
    libssl-dev \
    zlib1g-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    && rm -rf /var/lib/apt/lists/*

# 3. Create User & Setup Directories
# We create the group and user manually
RUN groupadd -g $GID $USER && \
    useradd -m -u $UID -g $GID -s /bin/bash $USER

# 4. Install 'uv' globally
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# 5. Setup /app directory with correct permissions
# We create it as root, then give ownership to the developer user
WORKDIR /app
RUN chown $USER:$GID /app

# 6. Switch to non-root user
USER $USER

# 7. Setup Virtual Environment
# We use Python 3.10 because Pytorch3D has issues with 3.12 removal of 'distutils'
ENV VIRTUAL_ENV=/app/.venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
RUN uv venv --python 3.10

# 8. Install Dependencies (Sequential Strategy)
# We avoid 'uv sync' to prevent lockfile conflicts and compilation order issues

# A. Build Tools
RUN uv pip install setuptools wheel

# B. PyTorch (CUDA Version this time, since we have the base image!)
# Note: Pytorch3D compilation requires the CUDA version of torch matching the NVCC version
RUN uv pip install torch torchvision 
#--index-url https://download.pytorch.org/whl/cpu

# C. Pytorch3D Build Dependencies
RUN uv pip install fvcore iopath portalocker

# D. Install Pytorch3D (Compiling with CUDA support)
# We set FORCE_CUDA=1 so it uses the NVCC from the base image
# ENV FORCE_CUDA=1
RUN uv pip install "git+https://github.com/facebookresearch/pytorch3d.git@stable" --no-build-isolation

# E. Install App Dependencies
RUN uv pip install \
    fastapi \
    uvicorn \
    gdown \
    albumentations \
    matplotlib \
    pandas \
    opencv-python-headless \
    websockets \
    trimesh \
    rtree \
    scipy \
    scikit-learn \
    scikit-image \
    numpy

# 9. COPY THE ROOT REPO (With Ownership Fix!)
# This --chown flag is CRITICAL. It ensures the user owns the copied files.
COPY --chown=$USER:$GID . /app

# 10. Fix Import Paths
# Ensure 'dermsynth3d' (root) is found
ENV PYTHONPATH="/app:/app/skin3d:$PYTHONPATH"

# 11. Switch to webapp directory
WORKDIR /app/webapp

# 12. Run the App
CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "10000"]